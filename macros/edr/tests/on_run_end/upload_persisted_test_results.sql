
{% macro upload_persisted_test_results() %}
    {% do elementary.upload_dbt_tests() %}
    {{ elementary.file_log("Handling test results.") }}
    {{ elementary.file_log("Get relation. " ~ elementary.get_elementary_relation('test_result_rows')) }}

    {% set cached_elementary_test_results = {'test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d': [{'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d', 'test_unique_id': 'test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d', 'model_unique_id': 'model.jaffle_shop.customers', 'detected_at': '2024-08-07 05:04:39', 'database_name': None, 'schema_name': 'dwh', 'table_name': 'customers', 'column_name': 'customer_id', 'test_type': 'dbt_test', 'test_sub_type': 'generic', 'other': None, 'owners': [], 'tags': [], 'test_results_query': '\n    \n    \n\n\n\nselect customer_id\nfrom `dwh`.`customers`\nwhere customer_id is null\n\n\n', 'test_name': 'not_null_customers_customer_id', 'test_params': {'column_name': 'customer_id', 'model': "{{ get_where_subquery(ref('customers')) }}"}, 'severity': 'ERROR', 'test_short_name': 'not_null', 'test_alias': 'not_null_customers_customer_id', 'status': 'pass', 'failures': 0, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': 0, 'test_results_description': None}], 'test.jaffle_shop.test1': [{'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test1', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test1', 'test_unique_id': 'test.jaffle_shop.test1', 'model_unique_id': None, 'detected_at': '2024-08-07 05:04:40', 'database_name': None, 'schema_name': 'dwh', 'table_name': Undefined, 'column_name': None, 'test_type': 'dbt_test', 'test_sub_type': 'singular', 'other': None, 'owners': [], 'tags': [], 'test_results_query': 'select 1', 'test_name': 'test1', 'test_params': {}, 'severity': 'ERROR', 'test_short_name': 'test1', 'test_alias': 'test1', 'status': 'fail', 'failures': 1, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': None, 'test_results_description': 'Got 1 result, configured to fail if != 0'}], 'test.jaffle_shop.test2': [{'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test2', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test2', 'test_unique_id': 'test.jaffle_shop.test2', 'model_unique_id': None, 'detected_at': '2024-08-07 05:04:40', 'database_name': None, 'schema_name': 'dwh', 'table_name': Undefined, 'column_name': None, 'test_type': 'dbt_test', 'test_sub_type': 'singular', 'other': None, 'owners': [], 'tags': [], 'test_results_query': 'select 1', 'test_name': 'test2', 'test_params': {}, 'severity': 'ERROR', 'test_short_name': 'test2', 'test_alias': 'test2', 'status': 'fail', 'failures': 1, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': None, 'test_results_description': 'Got 1 result, configured to fail if != 0'}], 'test.jaffle_shop.test3': [{'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test3', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test3', 'test_unique_id': 'test.jaffle_shop.test3', 'model_unique_id': None, 'detected_at': '2024-08-07 05:04:40', 'database_name': None, 'schema_name': 'dwh', 'table_name': Undefined, 'column_name': None, 'test_type': 'dbt_test', 'test_sub_type': 'singular', 'other': None, 'owners': [], 'tags': [], 'test_results_query': 'select 1', 'test_name': 'test3', 'test_params': {}, 'severity': 'ERROR', 'test_short_name': 'test3', 'test_alias': 'test3', 'status': 'fail', 'failures': 1, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': None, 'test_results_description': 'Got 1 result, configured to fail if != 0'}], 'test.jaffle_shop.test4': [{'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test4', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test4', 'test_unique_id': 'test.jaffle_shop.test4', 'model_unique_id': None, 'detected_at': '2024-08-07 05:04:40', 'database_name': None, 'schema_name': 'dwh', 'table_name': Undefined, 'column_name': None, 'test_type': 'dbt_test', 'test_sub_type': 'singular', 'other': None, 'owners': [], 'tags': [], 'test_results_query': 'select 1', 'test_name': 'test4', 'test_params': {}, 'severity': 'ERROR', 'test_short_name': 'test4', 'test_alias': 'test4', 'status': 'fail', 'failures': 1, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': None, 'test_results_description': 'Got 1 result, configured to fail if != 0'}]} %}
    
    {% set cached_elementary_test_failed_row_counts = {'test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d': 0} %}
    
    {% set elementary_test_results = [{'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d', 'test_unique_id': 'test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d', 'model_unique_id': 'model.jaffle_shop.customers', 'detected_at': '2024-08-07 05:04:39', 'database_name': None, 'schema_name': 'dwh', 'table_name': 'customers', 'column_name': 'customer_id', 'test_type': 'dbt_test', 'test_sub_type': 'generic', 'other': None, 'owners': [], 'tags': [], 'test_results_query': '\n    \n    \n\n\n\nselect customer_id\nfrom `dwh`.`customers`\nwhere customer_id is null\n\n\n', 'test_name': 'not_null_customers_customer_id', 'test_params': {'column_name': 'customer_id', 'model': "{{ get_where_subquery(ref('customers')) }}"}, 'severity': 'ERROR', 'test_short_name': 'not_null', 'test_alias': 'not_null_customers_customer_id', 'status': 'pass', 'failures': 0, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': 0, 'test_results_description': None}, {'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test1', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test1', 'test_unique_id': 'test.jaffle_shop.test1', 'model_unique_id': None, 'detected_at': '2024-08-07 05:04:40', 'database_name': None, 'schema_name': 'dwh', 'table_name': Undefined, 'column_name': None, 'test_type': 'dbt_test', 'test_sub_type': 'singular', 'other': None, 'owners': [], 'tags': [], 'test_results_query': 'select 1', 'test_name': 'test1', 'test_params': {}, 'severity': 'ERROR', 'test_short_name': 'test1', 'test_alias': 'test1', 'status': 'fail', 'failures': 1, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': None, 'test_results_description': 'Got 1 result, configured to fail if != 0'}, {'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test2', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test2', 'test_unique_id': 'test.jaffle_shop.test2', 'model_unique_id': None, 'detected_at': '2024-08-07 05:04:40', 'database_name': None, 'schema_name': 'dwh', 'table_name': Undefined, 'column_name': None, 'test_type': 'dbt_test', 'test_sub_type': 'singular', 'other': None, 'owners': [], 'tags': [], 'test_results_query': 'select 1', 'test_name': 'test2', 'test_params': {}, 'severity': 'ERROR', 'test_short_name': 'test2', 'test_alias': 'test2', 'status': 'fail', 'failures': 1, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': None, 'test_results_description': 'Got 1 result, configured to fail if != 0'}, {'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test3', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test3', 'test_unique_id': 'test.jaffle_shop.test3', 'model_unique_id': None, 'detected_at': '2024-08-07 05:04:40', 'database_name': None, 'schema_name': 'dwh', 'table_name': Undefined, 'column_name': None, 'test_type': 'dbt_test', 'test_sub_type': 'singular', 'other': None, 'owners': [], 'tags': [], 'test_results_query': 'select 1', 'test_name': 'test3', 'test_params': {}, 'severity': 'ERROR', 'test_short_name': 'test3', 'test_alias': 'test3', 'status': 'fail', 'failures': 1, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': None, 'test_results_description': 'Got 1 result, configured to fail if != 0'}, {'id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test4', 'data_issue_id': None, 'test_execution_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test4', 'test_unique_id': 'test.jaffle_shop.test4', 'model_unique_id': None, 'detected_at': '2024-08-07 05:04:40', 'database_name': None, 'schema_name': 'dwh', 'table_name': Undefined, 'column_name': None, 'test_type': 'dbt_test', 'test_sub_type': 'singular', 'other': None, 'owners': [], 'tags': [], 'test_results_query': 'select 1', 'test_name': 'test4', 'test_params': {}, 'severity': 'ERROR', 'test_short_name': 'test4', 'test_alias': 'test4', 'status': 'fail', 'failures': 1, 'invocation_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa', 'failed_row_count': None, 'test_results_description': 'Got 1 result, configured to fail if != 0'}] %}
    
    {% set tables_cache = {'metrics': {'relations': [], 'rows': []}, 'schema_snapshots': []} %}
    
    {% set test_result_rows = [{'elementary_test_results_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test1', 'detected_at': '2024-08-07 05:04:40', 'result_row': {'1': 1}}, {'elementary_test_results_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test2', 'detected_at': '2024-08-07 05:04:40', 'result_row': {'1': 1}}, {'elementary_test_results_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test3', 'detected_at': '2024-08-07 05:04:40', 'result_row': {'1': 1}}, {'elementary_test_results_id': '4f2cb936-ffe1-4577-9919-b91d6b2f99fa.test.jaffle_shop.test4', 'detected_at': '2024-08-07 05:04:40', 'result_row': {'1': 1}}] %}
    

    {% set store_result_rows_in_own_table = elementary.get_config_var("store_result_rows_in_own_table") %}

    {% set test_metrics_tables = tables_cache.get("metrics").get("relations") %}
    {% set test_columns_snapshot_tables = tables_cache.get("schema_snapshots") %}
    {% set database_name, schema_name = elementary.get_package_database_and_schema('elementary') %}


    {% do elementary.insert_data_monitoring_metrics(database_name, schema_name, test_metrics_tables) %}
    {% do elementary.insert_schema_columns_snapshot(database_name, schema_name, test_columns_snapshot_tables) %}
    {% if test_result_rows %}
      {% set test_result_rows_relation = elementary.get_elementary_relation('test_result_rows') %}
      {% do elementary.insert_rows(test_result_rows_relation, test_result_rows, should_commit=True, chunk_size=elementary.get_config_var('dbt_artifacts_chunk_size')) %}
    {% endif %}
    {% if elementary_test_results %}
      {% set elementary_test_results_relation = elementary.get_elementary_relation('elementary_test_results') %}
      {% do elementary.insert_rows(elementary_test_results_relation, elementary_test_results, should_commit=True, chunk_size=elementary.get_config_var('dbt_artifacts_chunk_size')) %}
    {% endif %}
    {% do elementary.file_log("Handled test results from cache successfully.") %}
    {% do return('') %}
{% endmacro %}
